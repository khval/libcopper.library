
// https://eab.abime.net/showthread.php?t=38014

#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <stdbool.h>
#include <string.h>

#include <proto/exec.h>
#include <proto/intuition.h>
#include <proto/graphics.h>

#include "render.h"
#include "binrary.h"

char *plane0 = NULL;

uint32 d0,d1,d2,d3,d4,d5,d6,d7;

uint32 *new_copperList = NULL;

struct Window *win = NULL;


#ifdef __amigaos4__
struct Custom _custom;
struct Custom *custom = &_custom;	// store locally... handle things with do_functions();
#else
struct Custom *custom = 0xDFF000;
#endif

#define setCustom_w(hwreg,value) cop_move_((uint32) (hwreg),(uint32) (value)&0xFFFF);
#define setCustom_l(hwreg,value) cop_move_((uint32) (hwreg), (uint32) (value)>>16); cop_move_( (uint32) (hwreg)+2,(uint32) (value)&0xFFFF);

#define swap_w(x) (((x & 0xFFFF0000) >> 16) | ((x & 0xFFFF) << 16))


uint32 plane0_ptr = 0;
uint32 plane1_ptr = 0;
uint32 plane2_ptr = 0;
uint32 plane3_ptr = 0;
uint32 plane4_ptr = 0;
uint32 plane5_ptr = 0;

#define move_w(value,addr) *((uint16 *) (addr)) = (value);

struct TagItem shared_tags[]={
		{AVT_Type,MEMF_SHARED},
		{TAG_END,0}
	};


bool prog_init()
{
	uint32 size;
	size = 320*256/8;


	plane0 = AllocVecTagList(size,shared_tags);
	new_copperList = AllocVecTagList(4 * 4000,shared_tags);	// not sure if 4000 is right number...

	if (!plane0) return false;
	if (!new_copperList) return false;

	memset(plane0,0x80,size);

	win = OpenWindowTags( NULL, 
			WA_IDCMP,IDCMP_MOUSEBUTTONS,
			WA_Left,320,
			WA_Top,20,
			WA_Width, 640,
			WA_Height, 520,
			TAG_END);

	if (!win) return false;

	return true;
}

void init_copper_list();

void cleanup()
{
	if (win) CloseWindow(win);
	win = NULL;

	if (plane0)	FreeVec(plane0);
	plane0 = NULL;

	if (new_copperList)	FreeVec(new_copperList);
	new_copperList = NULL;
}

int prog_main()
{


	init_copper_list();

	// set high and low word...

	d0 = (uint32) plane0;

	move_w(d0,plane0_ptr+6);
	move_w(d0,plane1_ptr+6);
	move_w(d0,plane2_ptr+6);
	move_w(d0,plane3_ptr+6);
	move_w(d0,plane4_ptr+6);
	move_w(d0,plane5_ptr+6);

	swap_w(d0);

	move_w(d0,plane0_ptr+2);
	move_w(d0,plane1_ptr+2);
	move_w(d0,plane2_ptr+2);
	move_w(d0,plane3_ptr+2);
	move_w(d0,plane4_ptr+2);
	move_w(d0,plane5_ptr+2);

//	move.l #copper_list,0xdff080

	setCustom_l( 0x080, new_copperList );

//	move.w D0,0xdff088

	setCustom_w( 0x088, d0 );
	setCustom_w( 0x096, B0000000001100000);
	setCustom_w( 0x096, B1000001110000000);

	render_copper( custom,copperList, win -> RPort );

	WaitLeftMouse(win);

	return 0;	
}

int main()
{
	int ret = -1;

	if (open_libs())
	{
		if (prog_init())
		{
			ret = prog_main();
		}
		cleanup();
	}
	close_libs();

	return ret;
}

void init_copper_list()
{
	uint32 *ptr = NULL;


	ptr = new_copperList;


	setCop(0x01fc,0x0000); //fmode=0
	setCop(0x0092,0x0038); //ddfstrt
	setCop(0x0094,0x00C0); //ddfstop
	setCop(0x008E,0x2c61); //diwstrt
	setCop(0x0090,0xf4f1); //diwstop
	
	setCop(0x0100,0x0000); //bplcon0
	setCop(0x0102,0x0000); //bplcon1 (horizontal scroll)
	setCop(0x0104,0x0000); //bplcon2
	setCop(0x0108,0x0000); //modulo = 0
	setCop(0x010A,0x0000); //modulo = 0
	
	setCop(0x0180,0x0000); //color 0
	setCop(0x0182,0x0555); //color 1
	setCop(0x0186,0x0400); //color 3
	setCop(0x018e,0x0040); //color 7'
	setCop(0x019e,0x0008); //color 15
	setCop(0x01be,0x0880); //color 31'

	plane0_ptr = (uint32) ptr;
	setCop(0x00e0,0x0000);
	setCop(0x00e2,0x0000);

	plane1_ptr = (uint32) ptr;
	setCop(0x00e4,0x0000);
	setCop(0x00e6,0x0000);

	plane2_ptr = (uint32) ptr;
	setCop(0x00e8,0x0000);
	setCop(0x00ea,0x0000);

	plane3_ptr = (uint32) ptr;
	setCop(0x00ec,0x0000);
	setCop(0x00ee,0x0000);

	plane4_ptr = (uint32) ptr;
	setCop(0x00f0,0x0000);
	setCop(0x00f2,0x0000);

	plane5_ptr = (uint32) ptr;
	setCop(0x00f4,0x0000);
	setCop(0x00f6,0x0000);

	setCop(0x3041,0xfffe);		// wait x 0x41,y 0x30
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);

	setCop(0x3241,0xfffe);		// wait x 0x42, y 0x32
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);

	setCop(0x3441,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0xffff,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x3641,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x4007,0xfffe); 
	setCop(0x0100,0x1000); //bplcon0

	setCop(0x4041,0xfffe);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);

	setCop(0x4241,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);

	setCop(0x4441,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0xffff,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x4641,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x5007,0xfffe); 
	setCop(0x0100,0x2000); //bplcon0

	setCop(0x5041,0xfffe);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);

	setCop(0x5241,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);

	setCop(0x5441,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0xffff,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x5641,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x6007,0xfffe); 
	setCop(0x0100,0x3000); //bplcon0

	setCop(0x6041,0xfffe);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);

	setCop(0x6241,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);

	setCop(0x6441,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0xffff,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x6641,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x7007,0xfffe); 
	setCop(0x0100,0x4000); //bplcon0

	setCop(0x7041,0xfffe);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);

	setCop(0x7241,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);

	setCop(0x7441,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0xffff,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x7641,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x8007,0xfffe); 
	setCop(0x0100,0x5000); //bplcon0

	setCop(0x8041,0xfffe);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);

	setCop(0x8241,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);

	setCop(0x8441,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0xffff,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x8641,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x9007,0xfffe); 
	setCop(0x0100,0x6000); //bplcon0

	setCop(0x9041,0xfffe);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);

	setCop(0x9241,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);

	setCop(0x9441,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0xffff,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0x9641,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0xA007,0xfffe);
	setCop(0x0100,0x9000); //bplcon0

	setCop(0xA041,0xfffe);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);

	setCop(0xA241,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);

	setCop(0xA441,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0xffff,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0xA641,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0xB007,0xfffe); 
	setCop(0x0100,0xA000); //bplcon0

	setCop(0xB041,0xfffe);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);

	setCop(0xB241,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);

	setCop(0xB441,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0xffff,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0xB641,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0xC007,0xfffe); 
	setCop(0x0100,0xB000); //bplcon0

	setCop(0xC041,0xfffe);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);

	setCop(0xC241,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);

	setCop(0xC441,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0xffff,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0xC641,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0xD007,0xfffe);
	setCop(0x0100,0xC000); //bplcon0

	setCop(0xD041,0xfffe);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00ff);
	setCop(0x0180,0x0000);

	setCop(0xD241,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xfffe);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x00f0);
	setCop(0x0180,0x0000);

	setCop(0xD441,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0xffff,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0xD641,0xfffe);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0001,0xffff);
	setCop(0x0180,0x0f00);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);
	setCop(0x0180,0x0ff0);
	setCop(0x0180,0x0000);

	setCop(0xE007,0xfffe); 
	setCop(0x0100,0x1000); //bplcon0

	setCop(0xffff,0xfffe);
}


